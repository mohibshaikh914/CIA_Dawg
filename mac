Option Explicit

' ************************************************************************************
' MASTER MACRO: BBG NAV (High-Performance Batch Version)
' ************************************************************************************
Sub RunAllProcesses_OneClick()
    Dim wbProcessed As Workbook
    Const OUTPUT_FILENAME As String = "Processed_Master_Data_NAV.xlsx"

    ' Disable background processes to maximize speed
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual 
    
    On Error GoTo ErrHandler
    
    ' 1. Data Preparation and Merging
    Set wbProcessed = Process_DataPrep_And_Merge(OUTPUT_FILENAME)
    
    If Not wbProcessed Is Nothing Then
        ' 2. High-Speed Bloomberg Data Retrieval
        Call Process_Bloomberg_Fast(wbProcessed)
        
        ' 3. Finalization and Save
        Application.Calculation = xlCalculationAutomatic 
        wbProcessed.SaveAs Filename:=ThisWorkbook.Path & "\" & OUTPUT_FILENAME, FileFormat:=xlOpenXMLWorkbook
        wbProcessed.Close SaveChanges:=False
        
        MsgBox "Process Complete! File saved as: " & OUTPUT_FILENAME, vbInformation
    End If
    
SafeExit:
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub
    
ErrHandler:
    MsgBox "An error occurred during execution: " & Err.Description, vbCritical
    Resume SafeExit
End Sub

' ************************************************************************************
' SUBROUTINE: Process_Bloomberg_Fast
' ************************************************************************************
Sub Process_Bloomberg_Fast(ByVal wbTarget As Workbook)
    Dim sStart As String, sEnd As String, ws As Worksheet
    Dim r As Long, lRow As Long
    Dim tCol As Long, navDateCol As Long, navValCol As Long, latNavCol As Long
    Dim deltaCol As Long, comCol As Long, bbcLCol As Long, ccyCol As Long, statCol As Long
    Dim ccyOverride As String
    
    Set ws = wbTarget.Sheets("CombinedData")
    lRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    
    ' Get Date Inputs
    sStart = Application.InputBox("Enter Start Date (YYYYMMDD):", "Date Range", Type:=2)
    sEnd = Application.InputBox("Enter End Date (YYYYMMDD):", "Date Range", Type:=2)
    If sStart = "False" Or sEnd = "False" Then Exit Sub

    ' Identify Column Indices Dynamically
    tCol = FindHeaderInSheet(ws, "Ticker")
    navDateCol = FindHeaderInSheet(ws, "NAV Date")
    navValCol = FindHeaderInSheet(ws, "NAV")
    latNavCol = FindHeaderInSheet(ws, "Latest NAV")
    deltaCol = FindHeaderInSheet(ws, "Delta")
    comCol = FindHeaderInSheet(ws, "Comment")
    bbcLCol = FindHeaderInSheet(ws, "BB Ccy Logic")
    ccyCol = FindHeaderInSheet(ws, "Currency")
    statCol = FindHeaderInSheet(ws, "BB Status")

    ' Step A: Batch Inject Market Status
    ws.Range(ws.Cells(2, statCol), ws.Cells(lRow, statCol)).FormulaR1C1 = _
        "=IFERROR(BDP(RC" & tCol & ",""MARKET_STATUS""),""#N/A"")"

    ' Step B: Batch Inject BDH Formulas (Processing logic per row for Currency)
    For r = 2 To lRow
        ccyOverride = ""
        If LCase(Trim(ws.Cells(r, bbcLCol).Value)) = "convert" Then
            ccyOverride = ",""currency=" & Trim(ws.Cells(r, ccyCol).Value) & """"
        End If
        ws.Cells(r, navDateCol).FormulaR1C1 = "=BDH(RC" & tCol & ",""FUND_TOTAL_ASSETS"",""" & sStart & """,""" & sEnd & """,""points=1""" & ccyOverride & ")"
    Next r

    ' Step C: Trigger Calculation and Wait for Bloomberg API Response
    Application.Calculate
    Application.Wait (Now + TimeValue("0:00:06")) ' 6-second buffer for API population
    DoEvents
    Application.Calculate

    ' Step D: Batch Inject Delta and Comment Formulas
    ws.Range(ws.Cells(2, deltaCol), ws.Cells(lRow, deltaCol)).FormulaR1C1 = _
        "=IFERROR((RC" & navValCol & " - RC" & latNavCol & ") / RC" & latNavCol & ", 0)"
    
    ws.Range(ws.Cells(2, comCol), ws.Cells(lRow, comCol)).FormulaR1C1 = _
        "=IF(OR(RC" & deltaCol & ">=0.5, RC" & deltaCol & "<=-0.5), ""CHECK"", ""UPDATE"")"

    ' Final Formatting
    ws.Columns(deltaCol).NumberFormat = "0.00%"
End Sub

' ************************************************************************************
' FUNCTION: Process_DataPrep_And_Merge
' ************************************************************************************
Function Process_DataPrep_And_Merge(ByVal sOutputName As String) As Workbook
    Dim wbTicker As Workbook, wbAllFund As Workbook, wbATE As Workbook, wbOut As Workbook
    Dim wsTicker As Worksheet, wsAllFund As Worksheet, wsATE As Worksheet, wsOut As Worksheet
    Dim loTicker As ListObject, loAllFund As ListObject
    Dim sFilePath As String, r As Long, i As Long
    Dim tickerDict As Object, ccyLogicDict As Object
    Dim buCol As Long, fundGciCol As Long, latNavCol As Long, latDateCol As Long
    Dim dbGci As Long, dbTick As Long, dbCcy As Long
    Dim arrCols As Variant
    
    Set tickerDict = CreateObject("Scripting.Dictionary")
    Set ccyLogicDict = CreateObject("Scripting.Dictionary")
    
    On Error GoTo PrepError

    ' File Selection
    sFilePath = GetFilePath("Select All Funds CSV"): If sFilePath = "" Then Exit Function
    Set wbAllFund = Workbooks.Open(sFilePath): Set wsAllFund = wbAllFund.Sheets(1)
    
    sFilePath = GetFilePath("Select ATE CSV"): If sFilePath = "" Then Exit Function
    Set wbATE = Workbooks.Open(sFilePath): Set wsATE = wbATE.Sheets(1)
    
    sFilePath = GetFilePath("Select BB Ticker Excel"): If sFilePath = "" Then Exit Function
    Set wbTicker = Workbooks.Open(sFilePath): Set wsTicker = wbTicker.Sheets(1)
    
    ' Initialize Tables
    Set loTicker = SetupListObject(wsTicker, "TickerTbl")
    If wsAllFund.UsedRange.Rows.Count > 0 Then wsAllFund.Rows(1).Delete
    Set loAllFund = SetupListObject(wsAllFund, "AllFundsTbl")
    
    ' Identify Headers
    buCol = HeaderIndex(loAllFund, "Business Unit")
    fundGciCol = HeaderIndex(loAllFund, "Fund GCI")
    latNavCol = HeaderIndex(loAllFund, "Latest NAV")
    latDateCol = HeaderIndex(loAllFund, "Latest NAV date")
    
    ' Apply Filters
    loAllFund.Range.AutoFilter Field:=buCol, Criteria1:=Array("FI-EMEA", "FI-US", "FI-GMC-Asia"), Operator:=xlFilterValues
    
    ' Load Ticker Dictionary
    dbGci = HeaderIndex(loTicker, "Fund GCI")
    dbTick = HeaderIndex(loTicker, "Ticker")
    dbCcy = HeaderIndex(loTicker, "Ccy")
    For r = 1 To loTicker.DataBodyRange.Rows.Count
        tickerDict(Trim(loTicker.DataBodyRange.Cells(r, dbGci).Value)) = loTicker.DataBodyRange.Cells(r, dbTick).Value
        ccyLogicDict(Trim(loTicker.DataBodyRange.Cells(r, dbGci).Value)) = LCase(Trim(loTicker.DataBodyRange.Cells(r, dbCcy).Value))
    Next r
    wbTicker.Close SaveChanges:=False

    ' Construct Output Sheet
    Set wbOut = Workbooks.Add(xlWBATWorksheet): Set wsOut = wbOut.Sheets(1)
    wsOut.Name = "CombinedData"
    arrCols = Array(buCol, HeaderIndex(loAllFund, "Fund name"), fundGciCol, latNavCol, latDateCol, HeaderIndex(loAllFund, "Currency"))
    
    For i = LBound(arrCols) To UBound(arrCols)
        loAllFund.ListColumns(arrCols(i)).Range.Resize(, 1).SpecialCells(xlCellTypeVisible).Copy
        wsOut.Cells(1, i + 1).PasteSpecial xlPasteValues
    Next i
    
    ' Map Tickers and Logic
    Dim tColIdx As Long: tColIdx = AddNewHeader(wsOut, "Ticker")
    Dim ccyLIdx As Long: ccyLIdx = AddNewHeader(wsOut, "BB Ccy Logic")
    Dim outGciIdx As Long: outGciIdx = FindHeaderInSheet(wsOut, "Fund GCI")
    
    For r = wsOut.Cells(wsOut.Rows.Count,
