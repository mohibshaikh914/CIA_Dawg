Option Explicit

' ************************************************************************************
' MASTER MACRO: BBG NPS (Net Per Share Version)
' ************************************************************************************
Sub RunAllProcesses_OneClick()
    Dim wbProcessed As Workbook
    Const OUTPUT_FILENAME As String = "Processed_Master_Data_NPS.xlsx"

    ' Optimization START
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual 
    
    On Error GoTo ErrHandler
    
    ' 1. EXECUTION STEP 1: Data Preparation
    Set wbProcessed = Process_DataPrep_And_Merge(OUTPUT_FILENAME)
    
    If Not wbProcessed Is Nothing Then
        ' 2. EXECUTION STEP 2: Bloomberg NPS Extraction and Calculation 
        Call Process_Bloomberg_And_Calculate(wbProcessed)
        
        ' Save the final combined data file
        Application.Calculation = xlCalculationAutomatic 
        Application.DisplayAlerts = False 
        wbProcessed.SaveAs Filename:=ThisWorkbook.Path & "\" & OUTPUT_FILENAME, FileFormat:=xlOpenXMLWorkbook
        Application.DisplayAlerts = True
        
        wbProcessed.Close savechanges:=False
        
        MsgBox "SUCCESS! The NPS process is completed. Final file: '" & OUTPUT_FILENAME & "'", vbInformation
    Else
        MsgBox "Process stopped. No data prepared.", vbExclamation
    End If
    
SafeExit:
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub
    
ErrHandler:
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    MsgBox "An unexpected error occurred: " & Err.Description, vbCritical
    If Not wbProcessed Is Nothing Then wbProcessed.Close savechanges:=False
End Sub

' ************************************************************************************
' FUNCTION: Process_DataPrep_And_Merge
' ************************************************************************************
Function Process_DataPrep_And_Merge(ByVal sOutputName As String) As Workbook
    Dim wbTicker As Workbook, wsTicker As Worksheet, loTicker As ListObject
    Dim wbAllFund As Workbook, wsAllFund As Worksheet, loAllFund As ListObject
    Dim wbATE As Workbook, wsATE As Worksheet, loATE As ListObject
    Dim wbOut As Workbook, wsOut As Worksheet
    Dim sFilePath As String, r As Long, i As Long
    Dim buCol As Long, fundGciCol As Long, reviewStatusCol As Long
    Dim invMgrCol As Long, iaGciCol As Long, fundNameCol As Long
    Dim fundCoperCol As Long, fundLEICol As Long, fundCodeCol As Long
    Dim currencyCol As Long, latestNpsCol As Long, latestNpsDateCol As Long
    Dim lTargetCol As Long, lTargetRow As Long, dbFundGciCol As Long, dbTickerCol As Long, dbCcyCol As Long
    Dim tCol As Long, bbcLCol As Long, outFundGciCol As Long, ateFundGciCol As Long
    Dim tickerDict As Object, ccyLogicDict As Object, ateD As Object
    Dim arrColIndices As Variant, sGci As String, curGci As String
    
    Set tickerDict = CreateObject("Scripting.Dictionary")
    Set ccyLogicDict = CreateObject("Scripting.Dictionary")
    
    On Error GoTo ErrHandler_Step1

    ' File Imports
    sFilePath = GetFilePath("Select the All Funds CSV file"): If sFilePath = "" Then GoTo SafeExit_Step1
    Set wbAllFund = Workbooks.Open(sFilePath): Set wsAllFund = wbAllFund.Sheets(1)
    
    sFilePath = GetFilePath("Select the ATE CSV file"): If sFilePath = "" Then GoTo SafeExit_Step1
    Set wbATE = Workbooks.Open(sFilePath): Set wsATE = wbATE.Sheets(1)
    
    sFilePath = GetFilePath("Select the BB Ticker Excel file"): If sFilePath = "" Then GoTo SafeExit_Step1
    Set wbTicker = Workbooks.Open(sFilePath): Set wsTicker = wbTicker.Sheets(1)
    Set loTicker = SetupListObject(wsTicker, "TickerTbl")
    
    ' Prep All Funds
    If wsAllFund.UsedRange.Rows.Count > 0 Then wsAllFund.Rows(1).Delete 
    Set loAllFund = SetupListObject(wsAllFund, "AllFundsTbl")
    
    ' Mapping Columns (Per Share source)
    buCol = HeaderIndex(loAllFund, "Business Unit")
    fundGciCol = HeaderIndex(loAllFund, "Fund GCI")
    invMgrCol = HeaderIndex(loAllFund, "Investment Manager")
    iaGciCol = HeaderIndex(loAllFund, "IA GCI")
    reviewStatusCol = HeaderIndex(loAllFund, "Review status")
    fundNameCol = HeaderIndex(loAllFund, "Fund name")
    fundCoperCol = HeaderIndex(loAllFund, "Fund Coper")
    fundLEICol = HeaderIndex(loAllFund, "Fund LEI")
    fundCodeCol = HeaderIndex(loAllFund, "Fund code")
    currencyCol = HeaderIndex(loAllFund, "Currency")
    latestNpsCol = HeaderIndex(loAllFund, "Latest NAV per share") 
    latestNpsDateCol = HeaderIndex(loAllFund, "Latest NAV per share date")
    
    loAllFund.Range.AutoFilter Field:=buCol, Criteria1:=Array("FI-EMEA", "FI-US", "FI-GMC-Asia"), Operator:=xlFilterValues
    
    ' Dict Load
    dbFundGciCol = HeaderIndex(loTicker, "Fund GCI")
    dbTickerCol = HeaderIndex(loTicker, "Ticker")
    dbCcyCol = HeaderIndex(loTicker, "Ccy")
    
    With loTicker.DataBodyRange
        For r = 1 To .Rows.Count
            sGci = Trim(.Cells(r, dbFundGciCol).Value)
            tickerDict(sGci) = .Cells(r, dbTickerCol).Value
            If dbCcyCol > 0 Then 
                ccyLogicDict(sGci) = LCase(Trim(.Cells(r, dbCcyCol).Value))
            End If
        Next r
    End With
    wbTicker.Close savechanges:=False
    
    ' Create Output Workbook
    arrColIndices = Array(buCol, invMgrCol, iaGciCol, reviewStatusCol, fundNameCol, _
                          fundGciCol, fundCoperCol, fundLEICol, fundCodeCol, currencyCol, _
                          latestNpsCol, latestNpsDateCol)
    
    Set wbOut = Workbooks.Add(xlWBATWorksheet): Set wsOut = wbOut.Sheets(1)
    wsOut.Name = "CombinedData"
    
    For i = LBound(arrColIndices) To UBound(arrColIndices)
        If arrColIndices(i) > 0 Then
            loAllFund.ListColumns(arrColIndices(i)).Range.Resize(, 1).SpecialCells(xlCellTypeVisible).Copy
            wsOut.Cells(1, i + 1).PasteSpecial Paste:=xlPasteValues 
        End If
    Next i
    
    lTargetRow = wsOut.Cells(wsOut.Rows.Count, 1).End(xlUp).Row
    If lTargetRow < 2 Then GoTo SafeExit_Step1

    ' New Columns for Logic
    lTargetCol = wsOut.Cells(1, wsOut.Columns.Count).End(xlToLeft).Column + 1
    wsOut.Cells(1, lTargetCol).Value = "Ticker": tCol = lTargetCol
    lTargetCol = lTargetCol + 1: wsOut.Cells(1, lTargetCol).Value = "BB Ccy Logic": bbcLCol = lTargetCol
    
    outFundGciCol = FindHeaderInSheet(wsOut, "Fund GCI")
    For r = lTargetRow To 2 Step -1
        curGci = Trim(wsOut.Cells(r, outFundGciCol).Value)
        If tickerDict.Exists(curGci) Then
            wsOut.Cells(r, tCol).Value = tickerDict(curGci)
            wsOut.Cells(r, bbcLCol).Value = ccyLogicDict(curGci)
        Else
            wsOut.Rows(r).Delete
        End If
    Next r
    
    lTargetRow = wsOut.Cells(wsOut.Rows.Count, 1).End(xlUp).Row
    
    ' ATE Match
    ateFundGciCol = HeaderIndex(loATE, "Fund GCI")
    If ateFundGciCol > 0 Then
        AddNewHeader wsOut, "ATE"
        Set ateD = CreateObject("Scripting.Dictionary")
        With loATE.DataBodyRange
            For r = 1 To .Rows.Count
                ateD(Trim(.Cells(r, ateFundGciCol).Value)) = True
            Next r
        End With
        For r = 2 To lTargetRow
            wsOut.Cells(r, FindHeaderInSheet(wsOut, "ATE")).Value = IIf(ateD.Exists(Trim(wsOut.Cells(r, outFundGciCol).Value)), "YES", "NO")
        Next r
    End If
    wbATE.Close savechanges:=False
    
    ' Headers (Renamed to NPS)
    Call AddNewHeader(wsOut, "BB Status")
    Call AddNewHeader(wsOut, "NPS Date")
    Call AddNewHeader(wsOut, "NPS")
    Call AddNewHeader(wsOut, "BB ccy")
    Call AddNewHeader(wsOut, "Delta")
    Call AddNewHeader(wsOut, "Comment")
    
    Set Process_DataPrep_And_Merge = wbOut
    Exit Function
    
ErrHandler_Step1:
    MsgBox "Error: " & Err.Description
    If Not wbOut Is Nothing Then wbOut.Close savechanges:=False
SafeExit_Step1:
    Set Process_DataPrep_And_Merge = Nothing
End Function

' ************************************************************************************
' SUBROUTINE: Process_Bloomberg_And_Calculate
' ************************************************************************************
Sub Process_Bloomberg_And_Calculate(ByVal wbTarget As Workbook)
    Dim sStartDate As String, sEndDate As String, ws As Worksheet, r As Long
    Dim tickerCol As Long, currencyCol As Long, bbCcyLogicCol As Long, npsDateCol As Long
    Dim npsValueCol As Long, latestNpsCol As Long, latestNpsDateCol As Long
    Dim deltaCol As Long, commentsCol As Long, bbCcyCol As Long, lRow As Long
    Dim sCcyOverride As String, sBDHField As String
    
    Set ws = wbTarget.Sheets("CombinedData")
    lRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    sBDHField = "FUND_NET_ASSET_VAL"
    
    tickerCol = FindHeaderInSheet(ws, "Ticker")
    currencyCol = FindHeaderInSheet(ws, "Currency")
    bbCcyLogicCol = FindHeaderInSheet(ws, "BB Ccy Logic")
    npsDateCol = FindHeaderInSheet(ws, "NPS Date") 
    npsValueCol = FindHeaderInSheet(ws, "NPS")               
    latestNpsCol = FindHeaderInSheet(ws, "Latest NAV per share")
    latestNpsDateCol = FindHeaderInSheet(ws, "Latest NAV per share date")
    deltaCol = FindHeaderInSheet(ws, "Delta")
    commentsCol = FindHeaderInSheet(ws, "Comment")
    bbCcyCol = FindHeaderInSheet(ws, "BB ccy") 

    sStartDate = Application.InputBox("Enter NPS Start Date (YYYYMMDD):", "Start Date", Type:=2)
    If sStartDate = "False" Then Exit Sub
    sEndDate = Application.InputBox("Enter NPS End Date (YYYYMMDD):", "End Date", Type:=2)
    If sEndDate = "False" Then Exit Sub
    
    For r = 2 To lRow
        sCcyOverride = ""
        If LCase(Trim(ws.Cells(r, bbCcyLogicCol).Value)) = "convert" Then
            sCcyOverride = ",""currency=" & Trim(ws.Cells(r, currencyCol).Value) & """"
        End If
        
        ws.Cells(r, FindHeaderInSheet(ws, "BB Status")).FormulaR1C1 = "=IFERROR(BDP(RC" & tickerCol & ",""MARKET_STATUS""),""#N/A"")"
        
        ' BDH FOR NPS
        ws.Cells(r, npsDateCol).FormulaR1C1 = "=BDH(RC" & tickerCol & ",""" & sBDHField & """,""" & sStartDate & """,""" & sEndDate & """,""points=1""" & sCcyOverride & ")"
        
        If sCcyOverride <> "" Then
            ws.Cells(r, bbCcyCol).Value = Trim(ws.Cells(r, currencyCol).Value)
        Else
            ws.Cells(r, bbCcyCol).FormulaR1C1 = "=IFERROR(BDP(RC" & tickerCol & ",""CURRENCY""),""#N/A"")"
        End If
        
        If r Mod 500 = 0 Then 
            Application.Calculate
            DoEvents
        End If
    Next r
    
    Application.Calculate
    ws.Cells(2, deltaCol).FormulaR1C1 = "=IFERROR((RC" & npsValueCol & " - RC" & latestNpsCol & ") / RC" & latestNpsCol & ", ""#N/A"")"
    ws.Range(ws.Cells(2, deltaCol), ws.Cells(lRow, deltaCol)).FillDown
    ws.Columns(deltaCol).NumberFormat = "0.00%"
    
    ' Delta Comment Logic (+/- 50%)
    ws.Cells(2, commentsCol).FormulaR1C1 = "=IF(OR(RC" & deltaCol & ">=0.5, RC" & deltaCol & "<=-0.5), ""CHECK"", ""UPDATE"")"
    ws.Range(ws.Cells(2, commentsCol), ws.Cells(lRow, commentsCol)).FillDown
    ws.Columns(latestNpsDateCol).NumberFormat = "mmddyyyy" 
End Sub

' ************************************************************************************
' SUPPORT FUNCTIONS
' ************************************************************************************
Private Function HeaderIndex(lo As ListObject, hName As String) As Long
    Dim c As Range
    For Each c In lo.HeaderRowRange.Cells
        If LCase(Trim(c.Value)) = LCase(Trim(hName)) Then
            HeaderIndex = c.Column
            Exit Function
        End If
    Next c
End Function

Private Function FindHeaderInSheet(ws As Worksheet, hName As String) As Long
    Dim r As Range
    Set r = ws.Rows(1).Find(What:=hName, LookIn:=xlValues, LookAt:=xlWhole, MatchCase:=False)
    If Not r Is Nothing Then
        FindHeaderInSheet = r.Column
    End If
End Function

Private Sub AddNewHeader(ws As Worksheet, hName As String)
    Dim lc As Long
    lc = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column + 1
    ws.Cells(1, lc).Value = hName
End Sub

Private Function GetFilePath(t As String) As String
    Dim f As FileDialog
    Set f = Application.FileDialog(msoFileDialogFilePicker)
    f.Title = t
    If f.Show = -1 Then
        GetFilePath = f.SelectedItems(1)
    End If
End Function

Private Function SetupListObject(ws As Worksheet, n As String) As ListObject
    Do While ws.ListObjects.Count > 0
        ws.ListObjects(1).Unlist
    Loop
    Set SetupListObject = ws.ListObjects.Add(xlSrcRange, ws.Range("A1").CurrentRegion, , xlYes)
    SetupListObject.Name = n
End Function
