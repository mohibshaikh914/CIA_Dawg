Option Explicit

' ************************************************************************************
' MASTER MACRO: Run this macro for the BBG NPS process.
' ************************************************************************************
Sub RunAllProcesses_OneClick()

    Dim wbProcessed As Workbook
    Const OUTPUT_FILENAME As String = "Processed_Master_Data_NPS.xlsx"

    ' === Optimization START ===
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual 
    
    On Error GoTo ErrHandler
    
    ' 1. EXECUTION STEP 1: Data Preparation
    Set wbProcessed = Process_DataPrep_And_Merge(OUTPUT_FILENAME)
    
    If Not wbProcessed Is Nothing Then
        
        ' 2. EXECUTION STEP 2: Bloomberg NPS Extraction and Calculation 
        Call Process_Bloomberg_And_Calculate(wbProcessed)
        
        ' Save the final combined data file
        Application.Calculation = xlCalculationAutomatic 
        Application.DisplayAlerts = False 
        wbProcessed.SaveAs Filename:=ThisWorkbook.Path & "\" & OUTPUT_FILENAME, FileFormat:=xlOpenXMLWorkbook
        Application.DisplayAlerts = True
        
        wbProcessed.Close savechanges:=False
        
        MsgBox "SUCCESS! The NPS process is completed. Final file: '" & OUTPUT_FILENAME & "'", vbInformation
    Else
        MsgBox "Process stopped. No data prepared.", vbExclamation
    End If
    
SafeExit:
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub
    
ErrHandler:
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    MsgBox "An unexpected error occurred: " & Err.Description, vbCritical
    If Not wbProcessed Is Nothing Then wbProcessed.Close savechanges:=False
    
End Sub

' ************************************************************************************
' FUNCTION: Process_DataPrep_And_Merge (NPS Source Replacement)
' ************************************************************************************
Function Process_DataPrep_And_Merge(ByVal sOutputName As String) As Workbook

    Dim wbTicker As Workbook, wsTicker As Worksheet, loTicker As ListObject
    Dim wbAllFund As Workbook, wsAllFund As Worksheet, loAllFund As ListObject
    Dim wbATE As Workbook, wsATE As Worksheet, loATE As ListObject
    Dim wbOut As Workbook, wsOut As Worksheet
    Dim sFilePath As String, r As Long, i As Long
    
    ' Column Index Variables for All Fund (REPLACED WITH PER SHARE)
    Dim buCol As Long, fundGciCol As Long, reviewStatusCol As Long
    Dim invMgrCol As Long, iaGciCol As Long, fundNameCol As Long
    Dim fundCoperCol As Long, fundLEICol As Long, fundCodeCol As Long
    Dim currencyCol As Long, latestNpsCol As Long, latestNpsDateCol As Long
    
    Dim lTargetCol As Long, lTargetRow As Long 
    Dim tickerDict As Object, ccyLogicDict As Object
    Set tickerDict = CreateObject("Scripting.Dictionary")
    Set ccyLogicDict = CreateObject("Scripting.Dictionary")
    
    On Error GoTo ErrHandler_Step1

    sFilePath = GetFilePath("Select the All Funds CSV file"): If sFilePath = "" Then GoTo SafeExit_Step1
    Set wbAllFund = Workbooks.Open(sFilePath)
    Set wsAllFund = wbAllFund.Sheets(1)
    
    sFilePath = GetFilePath("Select the ATE CSV file"): If sFilePath = "" Then GoTo SafeExit_Step1
    Set wbATE = Workbooks.Open(sFilePath)
    Set wsATE = wbATE.Sheets(1)
    
    sFilePath = GetFilePath("Select the BB Ticker Excel file"): If sFilePath = "" Then GoTo SafeExit_Step1
    Set wbTicker = Workbooks.Open(sFilePath)
    Set wsTicker = wbTicker.Sheets(1)
    Set loTicker = SetupListObject(wsTicker, "TickerTbl")
    
    If wsAllFund.UsedRange.Rows.Count > 0 Then wsAllFund.Rows(1).Delete 
    Set loAllFund = SetupListObject(wsAllFund, "AllFundsTbl")
    
    ' NEW SOURCE MAPPING
    buCol = HeaderIndex(loAllFund, "Business Unit")
    fundGciCol = HeaderIndex(loAllFund, "Fund GCI")
    invMgrCol = HeaderIndex(loAllFund, "Investment Manager")
    iaGciCol = HeaderIndex(loAllFund, "IA GCI")
    reviewStatusCol = HeaderIndex(loAllFund, "Review status")
    fundNameCol = HeaderIndex(loAllFund, "Fund name")
    fundCoperCol = HeaderIndex(loAllFund, "Fund Coper")
    fundLEICol = HeaderIndex(loAllFund, "Fund LEI")
    fundCodeCol = HeaderIndex(loAllFund, "Fund code")
    currencyCol = HeaderIndex(loAllFund, "Currency")
    latestNpsCol = HeaderIndex(loAllFund, "Latest NAV per share") ' REPLACED
    latestNpsDateCol = HeaderIndex(loAllFund, "Latest NAV per share date") ' REPLACED
    
    If buCol = 0 Or fundGciCol = 0 Then Err.Raise vbObjectError + 702, , "Essential columns missing in All Funds file."
    
    loAllFund.Range.AutoFilter Field:=buCol, Criteria1:=Array("FI-EMEA", "FI-US", "FI-GMC-Asia"), Operator:=xlFilterValues
    
    Dim dbFundGciCol As Long, dbTickerCol As Long, dbCcyCol As Long
    dbFundGciCol = HeaderIndex(loTicker, "Fund GCI")
    dbTickerCol = HeaderIndex(loTicker, "Ticker")
    dbCcyCol = HeaderIndex(loTicker, "Ccy")
    
    With loTicker.DataBodyRange
        For r = 1 To .Rows.Count
            Dim sGci As String: sGci = Trim(.Cells(r, dbFundGciCol).Value)
            tickerDict(sGci) = .Cells(r, dbTickerCol).Value
            If dbCcyCol > 0 Then ccyLogicDict(sGci) = LCase(Trim(.Cells(r, dbCcyCol).Value))
        Next r
    End With
    wbTicker.Close savechanges:=False
    
    Dim arrColIndices As Variant
    arrColIndices = Array(buCol, invMgrCol, iaGciCol, reviewStatusCol, fundNameCol, _
                          fundGciCol, fundCoperCol, fundLEICol, fundCodeCol, currencyCol, _
                          latestNpsCol, latestNpsDateCol)
    
    Set wbOut = Workbooks.Add(xlWBATWorksheet): Set wsOut = wbOut.Sheets(1)
    wsOut.Name = "CombinedData"
    
    ' Copy Visible Data
    For i = LBound(arrColIndices) To UBound(arrColIndices)
        If arrColIndices(i) > 0 Then
            loAllFund.ListColumns(arrColIndices(i)).Range.Resize(, 1).SpecialCells(xlCellTypeVisible).Copy
            wsOut.Cells(1, i + 1).PasteSpecial Paste:=xlPasteValues 
        End If
    Next i
    
    lTargetRow = wsOut.Cells(wsOut.Rows.Count, 1).End(xlUp).Row
    If lTargetRow < 2 Then GoTo SafeExit_Step1

    ' Map Ticker and Logic
    lTargetCol = wsOut.Cells(1, wsOut.Columns.Count).End(xlToLeft).Column + 1
    wsOut.Cells(1, lTargetCol).Value = "Ticker"
    Dim tCol As Long: tCol = lTargetCol
    lTargetCol = lTargetCol + 1: wsOut.Cells(1, lTargetCol).Value = "BB Ccy Logic"
    Dim bbcLCol As Long: bbcLCol = lTargetCol
    
    For r = lTargetRow To 2 Step -1
        Dim curGci As String: curGci = Trim(wsOut.Cells(r, FindHeaderInSheet(wsOut, "Fund GCI")).Value)
        If tickerDict.Exists(curGci) Then
            wsOut.Cells(r, tCol).Value = tickerDict(curGci)
            wsOut.Cells(r, bbcLCol).Value = ccyLogicDict(curGci)
        Else
            wsOut.Rows(r).Delete
        End If
    Next r
    
    lTargetRow = wsOut.Cells(wsOut.Rows.Count, 1).End(xlUp).Row
    
    ' ATE Mapping
    Dim ateFundGciCol As Long: ateFundGciCol = HeaderIndex(loATE, "Fund GCI")
    If ateFundGciCol > 0 Then
        AddNewHeader wsOut, "ATE"
        Dim ateD As Object: Set ateD = CreateObject("Scripting.Dictionary")
        With loATE.DataBodyRange: For r = 1 To .Rows.Count: ateD(Trim(.Cells(r, ateFundGciCol).Value)) = True: Next r: End With
        For r = 2 To lTargetRow
            wsOut.Cells(r, FindHeaderInSheet(wsOut, "ATE")).Value = IIf(ateD.Exists(Trim(wsOut.Cells(r, FindHeaderInSheet(wsOut, "Fund GCI")).Value)), "YES", "NO")
        Next r
    End If
    wbATE.Close savechanges:=False
    
    ' Final Headers Renaming
    Call AddNewHeader(wsOut, "BB Status")
    Call AddNewHeader(wsOut, "NPS Date") ' RENAMED
    Call AddNewHeader(wsOut, "NPS")      ' RENAMED
    Call AddNewHeader(wsOut, "BB ccy")
    Call AddNewHeader(wsOut, "Delta")
    Call AddNewHeader(wsOut, "Comment")
    
    Set Process_DataPrep_And_Merge = wbOut: Exit Function
ErrHandler_Step1:
    MsgBox "Error: " & Err.Description
    If Not wbOut Is Nothing Then wbOut.Close savechanges:=False
SafeExit_Step1:
    Set Process_DataPrep_And_Merge = Nothing
End Function

' ************************************************************************************
' SUBROUTINE: Process_Bloomberg_And_Calculate (NPS Field and Header logic)
' ************************************************************************************
Sub Process_Bloomberg_And_Calculate(ByVal wbTarget As Workbook)

    Dim sStartDate As String, sEndDate As String, ws As Worksheet, r As Long
    Set ws = wbTarget.Sheets("CombinedData"): Dim lRow As Long: lRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    
    ' Indices
    Dim tickerCol As Long: tickerCol = FindHeaderInSheet(ws, "Ticker")
    Dim currencyCol As Long: currencyCol = FindHeaderInSheet(ws, "Currency")
    Dim bbCcyLogicCol As Long: bbCcyLogicCol = FindHeaderInSheet(ws, "BB Ccy Logic")
    Dim npsDateCol As Long: npsDateCol = FindHeaderInSheet(ws, "NPS Date") 
    Dim npsValueCol As Long: npsValueCol = FindHeaderInSheet(ws, "NPS")               
    Dim latestNpsCol As Long: latestNpsCol = FindHeaderInSheet(ws, "Latest NAV per share")
    Dim latestNpsDateCol As Long: latestNpsDateCol = FindHeaderInSheet(ws, "Latest NAV per share date")
    Dim deltaCol As Long: deltaCol = FindHeaderInSheet(ws, "Delta")
    Dim commentsCol As Long: commentsCol = FindHeaderInSheet(ws, "Comment")
    Dim bbCcyCol As Long: bbCcyCol = FindHeaderInSheet(ws, "BB ccy") 

    sStartDate = Application.InputBox("Enter NPS Start Date (YYYYMMDD):", "Start Date", Type:=2)
    If sStartDate = "False" Then Exit Sub
    sEndDate = Application.InputBox("Enter NPS End Date (YYYYMMDD):", "End Date", Type:=2)
    If sEndDate = "False" Then Exit Sub
    
    For r = 2 To lRow
        Dim sCcyOverride As String: sCcyOverride = ""
        If LCase(Trim(ws.Cells(r, bbCcyLogicCol).Value)) = "convert" Then
            sCcyOverride = ",""currency=" & Trim(ws.Cells(r, currencyCol).Value) & """"
        End If
        
        ws.Cells(r, FindHeaderInSheet(ws, "BB Status")).FormulaR1C1 = "=IFERROR(BDP(RC" & tickerCol & ",""MARKET_STATUS""),""#N/A"")"
        ' BDH FOR FUND_NET_ASSET_VAL
        ws.Cells(r, npsDateCol).FormulaR1C1 = "=BDH(RC" & tickerCol & ",""FUND_NET_ASSET_VAL"",""" & sStartDate & """,""" & sEndDate & """,""points=1""" & sCcyOverride & ")"
        
        If sCcyOverride <> "" Then
            ws.Cells(r, bbCcyCol).Value = Trim(ws.Cells(r, currencyCol).Value)
        Else
            ws.Cells(r, bbCcyCol).FormulaR1C1 = "=IFERROR(BDP(RC" & tickerCol & ",""CURRENCY""),""#N/A"")"
        End If
        
        If r Mod 500 = 0 Then Application.Calculate: DoEvents
    Next r
    
    Application.Calculate
    ws.Cells(2, deltaCol).FormulaR1C1 = "=IFERROR((RC" & npsValueCol & " - RC" & latestNpsCol & ") / RC" & latestNpsCol & ", ""#N/A"")"
    ws.Range(ws.Cells(2, deltaCol), ws.Cells(lRow, deltaCol)).FillDown: ws.Columns(deltaCol).NumberFormat = "0.00%"
    
    ws.Cells(2, commentsCol).FormulaR1C1 = "=IF(OR(RC" & deltaCol & ">=0.5, RC" & deltaCol & "<=-0.5), ""CHECK"", ""UPDATE"")"
    ws.Range(ws.Cells(2, commentsCol), ws.Cells(lRow, commentsCol)).FillDown
    ws.Columns(latestNpsDateCol).NumberFormat = "mmddyyyy" 
    
End Sub

' ************************************************************************************
' SUPPORT FUNCTIONS
' ************************************************************************************
Private Function HeaderIndex(lo As ListObject, hName As String) As Long
    Dim c As Range: For Each c In lo.HeaderRowRange.Cells: If LCase(Trim(c.Value)) = LCase(Trim(hName)) Then HeaderIndex = c.Column: Exit Function: Next c
End Function

Private Function FindHeaderInSheet(ws As Worksheet, hName As String) As Long
    Dim r As Range: Set r = ws.Rows(1).Find(What:=hName, LookIn:=xlValues, LookAt:=xlWhole, MatchCase:=False)
    If Not r Is Nothing Then FindHeaderInSheet = r.Column
End Function

Private Sub AddNewHeader(ws As Worksheet, hName As String)
    Dim lc As Long: lc = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column + 1: ws.Cells(1, lc).Value = hName
End Sub

Private Function GetFilePath(t As String) As String
    Dim f As FileDialog: Set f = Application.FileDialog(msoFileDialogFilePicker)
    f.Title = t: If f.Show = -1 Then GetFilePath = f.SelectedItems(1)
End Function

Private Function SetupListObject(ws As Worksheet, n As String) As ListObject
    Set SetupListObject = ws.ListObjects.Add(xlSrcRange, ws.Range("A1").CurrentRegion, , xlYes): SetupListObject.Name = n
End Function
